#!/bin/sh

set -e

BUILD_DIR=$1
CACHE_DIR=$2

# Fontconfig
FONTCONFIG_VERSION="2.10.2"
FILE_NAME="fontconfig-${FONTCONFIG_VERSION}.tar.gz"

mkdir -p $CACHE_DIR
if ! [ -e $CACHE_DIR/$FILE_NAME ]; then
  echo "-----> building Fontconfig buildpack binaries"
  cd $CACHE_DIR
  echo $CACHE_DIR/$FILE_NAME
  curl http://www.freedesktop.org/software/fontconfig/release/$FILE_NAME > $CACHE_DIR/$FILE_NAME
  tar -xzf $FILE_NAME
  cd "fontconfig-${FONTCONFIG_VERSION}"
  ./configure
  make
fi

echo "-----> Extracting Fontconfig binaries"
mkdir -p $BUILD_DIR/vendor/fontconfig
echo "cp -rf \"${CACHE_DIR}/fontconfig-${FONTCONFIG_VERSION}/*\" $BUILD_DIR/vendor/fontconfig"
cp -rf "${CACHE_DIR}/fontconfig-${FONTCONFIG_VERSION}/" $BUILD_DIR/vendor/fontconfig

# Poppler
VERSION="0.37.0"
FILE_NAME="poppler-${VERSION}.tar.xz"

mkdir -p $CACHE_DIR
if ! [ -e $CACHE_DIR/$FILE_NAME ]; then
  echo "-----> building Poppler buildpack binaries"
  cd $CACHE_DIR
  curl http://poppler.freedesktop.org/$FILE_NAME > $CACHE_DIR/$FILE_NAME
  tar -xJf $FILE_NAME
  cd "poppler-${VERSION}"
  DISABLED="--disable-abiword-output --disable-gtk-test --disable-poppler-qt --disable-poppler-qt4 --disable-splash-output --disable-gdk"
  FREETYPE_CONFIG=freetype-config
  FONTCONFIG_LIBS="-L/${BUILD_DIR}/vendor/fontconfig/fontconfig-${FONTCONFIG_VERSION}/src/.libs/ -lfontconfig" FONTCONFIG_CFLAGS="-I/${BUILD_DIR}/vendor/fontconfig/fontconfig-${FONTCONFIG_VERSION}/" FREETYPE_LIBS=`$FREETYPE_CONFIG --libs` FREETYPE_CFLAGS=`$FREETYPE_CONFIG --cflags` ./configure --enable-static=yes --enable-shared=no $DISABLE
  make
fi

echo "-----> Extracting Poppler binaries"
mkdir -p $BUILD_DIR/vendor/poppler
cp -rf $CACHE_DIR/poppler-$VERSION $BUILD_DIR/vendor/poppler

echo "-----> Adding Poppler binaries to path"
PROFILE_PATH="$BUILD_DIR/.profile.d/poppler.sh"
mkdir -p $(dirname $PROFILE_PATH)

echo 'export PATH="$HOME/vendor/poppler/poppler-'$VERSION'/utils:$PATH"' >> $PROFILE_PATH
